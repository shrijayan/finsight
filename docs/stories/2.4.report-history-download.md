# Story 2.4: Report History & Download

## Status
Approved

## Story
**As a** user who has generated multiple financial analysis reports,
**I want** to view a history of all my past analyses and download them as PDFs for offline access,
**so that** I can track my financial progress over time, compare different periods, and keep records for my personal files.

## Acceptance Criteria
1. A history dashboard displays all user's analysis reports in chronological order
2. Each report entry shows title, creation date, source document count, and status
3. Users can click on any historical report to view its full dashboard
4. Reports can be downloaded as professional PDF documents with charts and insights
5. The history view is accessible via `/dashboard/history` route for authenticated users
6. Users can search and filter their report history by date range or keywords
7. The history dashboard shows loading states while fetching report data
8. Proper error handling displays helpful messages when history cannot be loaded
9. The interface includes pagination for users with many reports
10. Users can delete reports they no longer need (with confirmation)

## Tasks / Subtasks
- [x] Task 1: Create History Dashboard Route and Page (AC: 1, 5)
  - [x] Create `/dashboard/history/page.tsx` using Next.js App Router
  - [x] Implement proper authentication and route protection
  - [x] Set up responsive layout structure for report history
  - [x] Add navigation integration from main dashboard
- [x] Task 2: Build Report History Components (AC: 1, 2, 6, 9)
  - [x] Create ReportHistory component in `src/components/features/`
  - [x] Build ReportHistoryItem component for individual report entries
  - [x] Implement search functionality with debounced input
  - [x] Add date range filter with date picker components
  - [x] Create pagination controls for large report lists
- [x] Task 3: Implement History Data Fetching (AC: 7, 8)
  - [x] Create GET `/api/reports` endpoint to fetch user's report history
  - [x] Implement useReportHistory hook for data fetching and state management
  - [x] Add loading states with skeleton components
  - [x] Handle error states with user-friendly error messages
  - [x] Implement search and filter query parameters
- [x] Task 4: Create PDF Generation System (AC: 4)
  - [x] Install and configure PDF generation library (basic text-based PDF implementation)
  - [x] Create PDF template with professional styling
  - [x] Implement chart rendering for PDF format (basic text representation)
  - [x] Add report metadata and branding to PDF output
  - [x] Create GET `/api/reports/[reportId]/download` endpoint for PDF generation
- [x] Task 5: Add Report Management Features (AC: 10)
  - [x] Create DELETE `/api/reports/[reportId]` endpoint with proper authorization
  - [x] Implement delete confirmation modal with warning messages
  - [x] Add bulk operations (select multiple reports for deletion)
  - [x] Update UI state after successful deletion
- [x] Task 6: Enhance User Experience (AC: 3, 6)
  - [x] Add smooth navigation between history and individual reports  
  - [x] Implement advanced filtering (status, date range, keywords)
  - [x] Add report preview cards with key metrics
  - [x] Create export options (individual vs. bulk downloads)
  - [x] Include tooltips and help text for user guidance
- [x] Task 7: Optimize Performance (AC: 9)
  - [x] Implement server-side pagination for large datasets
  - [x] Add client-side caching for frequently accessed reports
  - [x] Optimize database queries for report listing
  - [x] Implement pagination based on UX preference
- [ ] Task 8: Testing and Quality Assurance (AC: 1-10)
  - [ ] Write component tests for history dashboard functionality
  - [ ] Test PDF generation with various report data structures
  - [ ] Verify search and filter functionality works correctly
  - [ ] Test pagination and performance with large datasets
  - [ ] Validate accessibility compliance and responsive design

## Dev Notes

### Previous Story Insights
From Story 2.3: Report display dashboard is complete with full visualization components. From Story 2.2: AnalysisReport model and repository are established with proper database structure for storing and retrieving reports.

### Project Structure Guide
[Source: architecture/unified-project-structure.md]
Report history components must follow the established structure:
```
src/
├── app/
│   ├── (app)/            # Route group for authenticated pages
│   │   └── dashboard/
│   │       └── history/
│   │           └── page.tsx        # History dashboard page
│   └── api/
│       └── reports/
│           ├── route.ts            # GET all reports for user
│           └── [reportId]/
│               └── download/
│                   └── route.ts    # PDF download endpoint
├── components/
│   ├── features/         # ReportHistory, ReportHistoryItem components
│   │   ├── ReportHistory.tsx
│   │   ├── ReportHistoryItem.tsx
│   │   ├── ReportSearchFilter.tsx
│   │   └── DeleteReportModal.tsx
│   └── ui/              # Pagination, SearchInput components
├── hooks/
│   └── useReportHistory.ts # Custom hook for history data fetching
├── lib/
│   └── pdf-generator.ts   # PDF generation utilities
└── stores/
    └── useHistoryStore.ts # History state management
```

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Framework**: Next.js ~14.2 with App Router for history routing
- **UI Components**: Shadcn/ui components for consistent design
- **PDF Generation**: jsPDF + html2canvas or Puppeteer for server-side PDF generation
- **Styling**: Tailwind CSS ~3.4 for responsive design and layouts
- **State Management**: Zustand ~4.5 for history data state management
- **Authentication**: NextAuth.js ~4.24 for secure history access

### Data Model Integration
[Source: architecture/data-models.md and Story 2.2]
**AnalysisReport Model (existing):**
```typescript
interface AnalysisReport {
  _id: string;
  userId: string;
  reportTitle: string;
  sourceDocumentCount: number;
  generatedData: AnalysisData;
  createdAt: Date;
  updatedAt: Date;
  status?: 'processing' | 'completed' | 'failed';
}
```

**History List Item Display:**
```typescript
interface ReportHistoryItem {
  id: string;
  title: string;
  createdAt: Date;
  sourceDocumentCount: number;
  status: string;
  keyMetrics: {
    totalIncome: number;
    totalExpenses: number;
    netCashFlow: number;
  };
}
```

### API Endpoints Implementation
**Reports History Endpoint:**
```typescript
// src/app/api/reports/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { analysisReportRepository } from '@packages/db/src/repositories/AnalysisReportRepository';

export async function GET(request: NextRequest) {
  try {
    const session = await getServerSession();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Authentication required' }, { status: 401 });
    }

    const { searchParams } = new URL(request.url);
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '10');
    const search = searchParams.get('search') || '';
    const startDate = searchParams.get('startDate');
    const endDate = searchParams.get('endDate');

    const filters = {
      userId: session.user.id,
      ...(search && { reportTitle: { $regex: search, $options: 'i' } }),
      ...(startDate && endDate && {
        createdAt: {
          $gte: new Date(startDate),
          $lte: new Date(endDate)
        }
      })
    };

    const reports = await analysisReportRepository.findPaginated(
      filters,
      { page, limit, sort: { createdAt: -1 } }
    );

    // Transform for history display
    const historyItems = reports.data.map(report => ({
      id: report._id,
      title: report.reportTitle,
      createdAt: report.createdAt,
      sourceDocumentCount: report.sourceDocumentCount,
      status: report.status || 'completed',
      keyMetrics: {
        totalIncome: report.generatedData?.totalIncome || 0,
        totalExpenses: report.generatedData?.totalExpenses || 0,
        netCashFlow: report.generatedData?.netCashFlow || 0,
      }
    }));

    return NextResponse.json({
      reports: historyItems,
      pagination: {
        page: reports.page,
        limit: reports.limit,
        total: reports.total,
        pages: reports.pages
      }
    });

  } catch (error) {
    console.error('Report history error:', error);
    return NextResponse.json({ error: 'Failed to fetch report history' }, { status: 500 });
  }
}
```

**PDF Download Endpoint:**
```typescript
// src/app/api/reports/[reportId]/download/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { analysisReportRepository } from '@packages/db/src/repositories/AnalysisReportRepository';
import { generateReportPDF } from '@/lib/pdf-generator';

export async function GET(
  request: NextRequest,
  { params }: { params: { reportId: string } }
) {
  try {
    const session = await getServerSession();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Authentication required' }, { status: 401 });
    }

    const report = await analysisReportRepository.findById(params.reportId);
    
    if (!report) {
      return NextResponse.json({ error: 'Report not found' }, { status: 404 });
    }

    // Verify user owns this report
    if (report.userId !== session.user.id) {
      return NextResponse.json({ error: 'Access denied' }, { status: 403 });
    }

    // Generate PDF
    const pdfBuffer = await generateReportPDF(report);

    return new NextResponse(pdfBuffer, {
      status: 200,
      headers: {
        'Content-Type': 'application/pdf',
        'Content-Disposition': `attachment; filename="${report.reportTitle.replace(/[^a-zA-Z0-9]/g, '_')}.pdf"`,
        'Content-Length': pdfBuffer.length.toString(),
      },
    });

  } catch (error) {
    console.error('PDF download error:', error);
    return NextResponse.json({ error: 'Failed to generate PDF' }, { status: 500 });
  }
}
```

### Report History Components
**History Dashboard Component:**
```typescript
// src/components/features/ReportHistory.tsx
'use client';

import * as React from 'react';
import { cn } from '@/lib/utils';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ReportHistoryItem } from './ReportHistoryItem';
import { ReportSearchFilter } from './ReportSearchFilter';
import { useReportHistory } from '@/hooks/useReportHistory';
import { Search, Download, Trash2 } from 'lucide-react';

interface ReportHistoryProps extends React.HTMLAttributes<HTMLDivElement> {}

export function ReportHistory({ className, ...props }: ReportHistoryProps) {
  const {
    reports,
    pagination,
    isLoading,
    error,
    searchQuery,
    setSearchQuery,
    selectedReports,
    toggleReportSelection,
    deleteReports,
    downloadReports,
    loadPage
  } = useReportHistory();

  const [showFilters, setShowFilters] = React.useState(false);

  if (error) {
    return (
      <div className="text-center py-8">
        <h2 className="text-xl font-semibold text-red-600 mb-2">Error Loading History</h2>
        <p className="text-gray-600">{error}</p>
      </div>
    );
  }

  return (
    <div className={cn('space-y-6', className)} {...props}>
      {/* Header with Search and Filters */}
      <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
        <div className="flex-1 max-w-md">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
            <Input
              placeholder="Search reports..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>
        </div>

        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={() => setShowFilters(!showFilters)}
          >
            Filters
          </Button>
          
          {selectedReports.length > 0 && (
            <>
              <Button
                variant="outline"
                onClick={() => downloadReports(selectedReports)}
              >
                <Download className="w-4 h-4 mr-2" />
                Download ({selectedReports.length})
              </Button>
              <Button
                variant="outline"
                onClick={() => deleteReports(selectedReports)}
                className="text-red-600 hover:text-red-700"
              >
                <Trash2 className="w-4 h-4 mr-2" />
                Delete ({selectedReports.length})
              </Button>
            </>
          )}
        </div>
      </div>

      {/* Advanced Filters */}
      {showFilters && (
        <Card className="p-4">
          <ReportSearchFilter />
        </Card>
      )}

      {/* Report History List */}
      <div className="space-y-4">
        {isLoading ? (
          Array.from({ length: 5 }).map((_, index) => (
            <div key={index} className="bg-gray-100 animate-pulse h-32 rounded-lg" />
          ))
        ) : reports.length === 0 ? (
          <div className="text-center py-12">
            <h3 className="text-lg font-medium text-gray-600 mb-2">No Reports Found</h3>
            <p className="text-gray-500">You haven't generated any financial analysis reports yet.</p>
          </div>
        ) : (
          reports.map((report) => (
            <ReportHistoryItem
              key={report.id}
              report={report}
              isSelected={selectedReports.includes(report.id)}
              onToggleSelect={() => toggleReportSelection(report.id)}
            />
          ))
        )}
      </div>

      {/* Pagination */}
      {pagination.pages > 1 && (
        <div className="flex justify-center items-center space-x-2">
          <Button
            variant="outline"
            disabled={pagination.page === 1}
            onClick={() => loadPage(pagination.page - 1)}
          >
            Previous
          </Button>
          
          <span className="text-sm text-gray-600">
            Page {pagination.page} of {pagination.pages}
          </span>
          
          <Button
            variant="outline"
            disabled={pagination.page === pagination.pages}
            onClick={() => loadPage(pagination.page + 1)}
          >
            Next
          </Button>
        </div>
      )}
    </div>
  );
}
```

**Individual Report History Item:**
```typescript
// src/components/features/ReportHistoryItem.tsx
import * as React from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import { Eye, Download, Calendar, FileText, DollarSign } from 'lucide-react';
import Link from 'next/link';

interface ReportHistoryItemProps {
  report: ReportHistoryItem;
  isSelected: boolean;
  onToggleSelect: () => void;
}

export function ReportHistoryItem({ 
  report, 
  isSelected, 
  onToggleSelect 
}: ReportHistoryItemProps) {
  const handleDownload = async (e: React.MouseEvent) => {
    e.preventDefault();
    e.stopPropagation();
    
    try {
      const response = await fetch(`/api/reports/${report.id}/download`);
      if (response.ok) {
        const blob = await response.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${report.title}.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
    } catch (error) {
      console.error('Download failed:', error);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800';
      case 'processing': return 'bg-yellow-100 text-yellow-800';
      case 'failed': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  return (
    <Card className="hover:shadow-md transition-shadow">
      <CardContent className="p-4">
        <div className="flex items-start gap-4">
          <Checkbox
            checked={isSelected}
            onCheckedChange={onToggleSelect}
            className="mt-1"
          />
          
          <div className="flex-1">
            <div className="flex items-start justify-between mb-2">
              <div>
                <h3 className="text-lg font-medium text-gray-900 mb-1">
                  {report.title}
                </h3>
                <div className="flex items-center text-sm text-gray-600 space-x-4">
                  <span className="flex items-center">
                    <Calendar className="w-4 h-4 mr-1" />
                    {new Date(report.createdAt).toLocaleDateString()}
                  </span>
                  <span className="flex items-center">
                    <FileText className="w-4 h-4 mr-1" />
                    {report.sourceDocumentCount} {report.sourceDocumentCount === 1 ? 'document' : 'documents'}
                  </span>
                </div>
              </div>
              
              <div className="flex items-center space-x-2">
                <Badge className={getStatusColor(report.status)}>
                  {report.status}
                </Badge>
              </div>
            </div>

            {/* Key Metrics Preview */}
            <div className="grid grid-cols-3 gap-4 mb-4 p-3 bg-gray-50 rounded-lg">
              <div className="text-center">
                <p className="text-sm text-gray-600">Income</p>
                <p className="font-semibold text-green-600">
                  ${report.keyMetrics.totalIncome.toLocaleString()}
                </p>
              </div>
              <div className="text-center">
                <p className="text-sm text-gray-600">Expenses</p>
                <p className="font-semibold text-red-600">
                  ${report.keyMetrics.totalExpenses.toLocaleString()}
                </p>
              </div>
              <div className="text-center">
                <p className="text-sm text-gray-600">Net Flow</p>
                <p className={`font-semibold ${
                  report.keyMetrics.netCashFlow >= 0 ? 'text-green-600' : 'text-red-600'
                }`}>
                  ${report.keyMetrics.netCashFlow.toLocaleString()}
                </p>
              </div>
            </div>

            {/* Actions */}
            <div className="flex justify-end space-x-2">
              <Button
                variant="outline"
                size="sm"
                onClick={handleDownload}
              >
                <Download className="w-4 h-4 mr-1" />
                Download PDF
              </Button>
              
              <Link href={`/dashboard/reports/${report.id}`}>
                <Button size="sm">
                  <Eye className="w-4 h-4 mr-1" />
                  View Report
                </Button>
              </Link>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

### PDF Generation Implementation
**PDF Generator Utility:**
```typescript
// src/lib/pdf-generator.ts
import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

export async function generateReportPDF(report: AnalysisReport): Promise<Buffer> {
  try {
    const pdf = new jsPDF('p', 'mm', 'a4');
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Add header
    pdf.setFontSize(20);
    pdf.setFont('helvetica', 'bold');
    pdf.text(report.reportTitle, pageWidth / 2, 20, { align: 'center' });

    // Add creation date
    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'normal');
    pdf.text(
      `Generated on ${new Date(report.createdAt).toLocaleDateString()}`,
      pageWidth / 2,
      30,
      { align: 'center' }
    );

    let yPosition = 50;

    // Add key metrics section
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.text('Financial Summary', 20, yPosition);
    yPosition += 10;

    pdf.setFontSize(12);
    pdf.setFont('helvetica', 'normal');
    const metrics = report.generatedData;
    
    pdf.text(`Total Income: $${metrics.totalIncome.toLocaleString()}`, 20, yPosition);
    yPosition += 7;
    pdf.text(`Total Expenses: $${metrics.totalExpenses.toLocaleString()}`, 20, yPosition);
    yPosition += 7;
    pdf.text(`Net Cash Flow: $${metrics.netCashFlow.toLocaleString()}`, 20, yPosition);
    yPosition += 15;

    // Add insights section
    if (metrics.insights && metrics.insights.length > 0) {
      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Key Insights', 20, yPosition);
      yPosition += 10;

      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'normal');
      
      metrics.insights.forEach((insight, index) => {
        const lines = pdf.splitTextToSize(
          `${index + 1}. ${insight.description}`,
          pageWidth - 40
        );
        
        if (yPosition + (lines.length * 5) > pageHeight - 20) {
          pdf.addPage();
          yPosition = 20;
        }
        
        lines.forEach((line: string) => {
          pdf.text(line, 20, yPosition);
          yPosition += 5;
        });
        yPosition += 3;
      });
    }

    // Add recommendations section
    if (metrics.recommendations && metrics.recommendations.length > 0) {
      yPosition += 10;
      
      if (yPosition > pageHeight - 30) {
        pdf.addPage();
        yPosition = 20;
      }

      pdf.setFontSize(16);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Recommendations', 20, yPosition);
      yPosition += 10;

      pdf.setFontSize(10);
      pdf.setFont('helvetica', 'normal');
      
      metrics.recommendations.forEach((recommendation, index) => {
        const lines = pdf.splitTextToSize(
          `${index + 1}. ${recommendation.suggestion} (Potential savings: $${recommendation.potentialSavings.toLocaleString()})`,
          pageWidth - 40
        );
        
        if (yPosition + (lines.length * 5) > pageHeight - 20) {
          pdf.addPage();
          yPosition = 20;
        }
        
        lines.forEach((line: string) => {
          pdf.text(line, 20, yPosition);
          yPosition += 5;
        });
        yPosition += 3;
      });
    }

    return Buffer.from(pdf.output('arraybuffer'));

  } catch (error) {
    console.error('PDF generation error:', error);
    throw new Error('Failed to generate PDF report');
  }
}
```

### Custom Hooks Implementation
**Report History Hook:**
```typescript
// src/hooks/useReportHistory.ts
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';

interface ReportHistoryState {
  reports: ReportHistoryItem[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    pages: number;
  };
  isLoading: boolean;
  error: string | null;
  searchQuery: string;
  selectedReports: string[];
}

export function useReportHistory() {
  const { data: session } = useSession();
  const [state, setState] = useState<ReportHistoryState>({
    reports: [],
    pagination: { page: 1, limit: 10, total: 0, pages: 0 },
    isLoading: false,
    error: null,
    searchQuery: '',
    selectedReports: []
  });

  const fetchReports = async (page = 1, search = '') => {
    if (!session?.user) return;

    setState(prev => ({ ...prev, isLoading: true, error: null }));

    try {
      const params = new URLSearchParams({
        page: page.toString(),
        limit: state.pagination.limit.toString(),
        ...(search && { search })
      });

      const response = await fetch(`/api/reports?${params}`);
      
      if (!response.ok) {
        throw new Error('Failed to fetch report history');
      }

      const data = await response.json();
      
      setState(prev => ({
        ...prev,
        reports: data.reports,
        pagination: data.pagination,
        isLoading: false
      }));

    } catch (error) {
      setState(prev => ({
        ...prev,
        error: error instanceof Error ? error.message : 'Unknown error',
        isLoading: false
      }));
    }
  };

  useEffect(() => {
    fetchReports();
  }, [session]);

  const setSearchQuery = (query: string) => {
    setState(prev => ({ ...prev, searchQuery: query }));
    fetchReports(1, query);
  };

  const loadPage = (page: number) => {
    fetchReports(page, state.searchQuery);
  };

  const toggleReportSelection = (reportId: string) => {
    setState(prev => ({
      ...prev,
      selectedReports: prev.selectedReports.includes(reportId)
        ? prev.selectedReports.filter(id => id !== reportId)
        : [...prev.selectedReports, reportId]
    }));
  };

  const deleteReports = async (reportIds: string[]) => {
    // Implementation for bulk delete
    console.log('Deleting reports:', reportIds);
  };

  const downloadReports = async (reportIds: string[]) => {
    // Implementation for bulk download
    console.log('Downloading reports:', reportIds);
  };

  return {
    ...state,
    setSearchQuery,
    loadPage,
    toggleReportSelection,
    deleteReports,
    downloadReports,
    refetch: () => fetchReports(state.pagination.page, state.searchQuery)
  };
}
```

### History Page Implementation
**History Dashboard Page:**
```typescript
// src/app/(app)/dashboard/history/page.tsx
'use client';

import * as React from 'react';
import { ReportHistory } from '@/components/features/ReportHistory';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Plus } from 'lucide-react';
import Link from 'next/link';

export default function HistoryPage() {
  return (
    <div className="container mx-auto px-4 py-8">
      {/* Header */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center space-x-4">
          <Link href="/dashboard">
            <Button variant="outline" size="sm">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Dashboard
            </Button>
          </Link>
          <div>
            <h1 className="text-2xl font-bold text-gray-900">Report History</h1>
            <p className="text-gray-600">View and manage your financial analysis reports</p>
          </div>
        </div>

        <Link href="/dashboard">
          <Button>
            <Plus className="w-4 h-4 mr-2" />
            New Analysis
          </Button>
        </Link>
      </div>

      {/* Report History Component */}
      <ReportHistory />
    </div>
  );
}
```

### Repository Enhancement
**Enhanced Repository with Pagination:**
```typescript
// packages/db/src/repositories/AnalysisReportRepository.ts (enhanced)
export class AnalysisReportRepository {
  // ... existing methods ...

  async findPaginated(
    filters: any,
    options: { page: number; limit: number; sort?: any }
  ) {
    const { page, limit, sort = { createdAt: -1 } } = options;
    const skip = (page - 1) * limit;

    const [data, total] = await Promise.all([
      AnalysisReport.find(filters)
        .sort(sort)
        .skip(skip)
        .limit(limit)
        .exec(),
      AnalysisReport.countDocuments(filters).exec()
    ]);

    return {
      data,
      page,
      limit,
      total,
      pages: Math.ceil(total / limit)
    };
  }

  async deleteById(reportId: string, userId: string) {
    return AnalysisReport.findOneAndDelete({ 
      _id: reportId, 
      userId 
    }).exec();
  }

  async
