# Story 1.3: User Registration Flow

## Status
Draft

## Story
**As a** potential user of the Bank Statement Analyzer,
**I want** to create a new account with my name, email, and password,
**so that** I can access the application and have my analysis reports saved to my personal account.

## Acceptance Criteria
1. A registration form is accessible via `/register` route with name, email, and password fields
2. The registration form includes proper client-side validation (required fields, email format, password strength)
3. A POST `/api/auth/register` endpoint processes registration requests securely
4. Passwords are properly hashed before storage using industry-standard methods
5. The system prevents duplicate registrations for the same email address
6. Upon successful registration, the user is redirected to the login page with a success message
7. Registration errors are displayed clearly to the user with specific guidance
8. The registration form follows the established UI design patterns and is responsive
9. All form interactions include proper loading states and accessibility features

## Tasks / Subtasks
- [x] Task 1: Create Registration Page Route (AC: 1)
  - [x] Create `/register` route in `src/app/(auth)/register/page.tsx`
  - [x] Follow Next.js App Router structure for auth pages
  - [x] Implement proper page layout with responsive design
- [x] Task 2: Build Registration Form Component (AC: 1, 2, 8, 9)
  - [x] Create RegistrationForm component in `src/components/features/`
  - [x] Include form fields: name, email, password, confirm password
  - [x] Implement client-side validation with appropriate error messages
  - [x] Add loading states, proper accessibility attributes
  - [x] Use Shadcn/ui components (Button, Input, Label) with proper styling
- [x] Task 3: Create Registration API Endpoint (AC: 3, 4, 5, 6, 7)
  - [x] Create POST `/api/auth/register/route.ts` following API template
  - [x] Implement input validation using Zod schema
  - [x] Hash passwords using secure hashing (bcrypt with 12 salt rounds)
  - [x] Use UserRepository to check for existing users and create new users
  - [x] Return appropriate HTTP status codes and error messages
- [x] Task 4: Integrate Frontend with Backend (AC: 6, 7)
  - [x] Frontend-backend integration implemented in RegistrationForm
  - [x] Handle successful registration (redirect to login with success message)
  - [x] Handle registration errors (display specific error messages)
  - [x] Implement proper error handling for network failures
- [x] Task 5: Testing and Validation (AC: 1-9)
  - [x] Write component tests for registration form validation
  - [x] Write API route tests for registration endpoint
  - [x] Test error scenarios (duplicate email, invalid input, server errors)
  - [x] Verify accessibility compliance (proper ARIA attributes, labels)
  - [x] Responsive design implemented with Tailwind CSS

## Dev Notes

### Previous Story Insights
From Story 1.2: User model and database setup is complete, including:
- User MongoDB model with proper schema validation
- UserRepository with findByEmail() and create() methods established  
- TypeScript interfaces for User type sharing
- Database connection configured for serverless environment

### Project Structure Guide
[Source: architecture/unified-project-structure.md]
Registration components must follow the established structure:
```
src/
├── app/
│   ├── (auth)/           # Route group for auth pages
│   │   ├── register/
│   │   │   └── page.tsx  # Registration page route
│   │   └── layout.tsx    # Auth layout (if needed)
│   └── api/
│       └── auth/
│           └── register/
│               └── route.ts  # Registration API endpoint
├── components/
│   ├── features/         # RegistrationForm component
│   └── ui/              # Shadcn/ui components
└── lib/
    └── apiClient.ts     # API service functions
```

### Frontend Architecture Standards
[Source: architecture/frontend-architecture.md]
**Component Template Pattern:**
```typescript
import * as React from 'react';
import { cn } from '@/lib/utils';

interface RegistrationFormProps extends React.HTMLAttributes<HTMLDivElement> {
  onSuccess?: (message: string) => void;
  onError?: (error: string) => void;
}

const RegistrationForm = React.forwardRef<HTMLDivElement, RegistrationFormProps>(
  ({ className, onSuccess, onError, ...props }, ref) => {
    // Component implementation
  }
);
RegistrationForm.displayName = 'RegistrationForm';

export { RegistrationForm };
```

**Route Organization:**
- Use Next.js App Router: `/register` route via `src/app/(auth)/register/page.tsx`
- Group auth pages using (auth) route group for shared layouts
- Follow protected route patterns for post-registration redirects

### API Specification Implementation
[Source: architecture/api-specification.md]
**POST /api/auth/register endpoint:**
```yaml
/auth/register:
  post:
    summary: Register a new user
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              name: { type: string }
              email: { type: string }
              password: { type: string }
    responses:
      '201':
        description: User created successfully
        content:
          application/json:
            schema:
              type: object
              properties:
                message: { type: string }
                user: { $ref: '#/components/schemas/User' }
      '400':
        description: Invalid input or duplicate email
      '500':
        description: Server error
```

### Backend API Route Template
[Source: architecture/backend-architecture.md]
```typescript
import { NextResponse } from 'next/server';
import { z } from 'zod';
import bcrypt from 'bcryptjs';
import { userRepository } from '@/packages/db/src/repositories/UserRepository';

const registerSchema = z.object({
  name: z.string().min(2, 'Name must be at least 2 characters'),
  email: z.string().email('Please enter a valid email address'),
  password: z.string().min(8, 'Password must be at least 8 characters'),
});

export async function POST(request: Request) {
  try {
    const body = await request.json();
    const validatedData = registerSchema.parse(body);

    // Check for existing user
    const existingUser = await userRepository.findByEmail(validatedData.email);
    if (existingUser) {
      return NextResponse.json({ error: 'User already exists' }, { status: 400 });
    }

    // Hash password and create user
    const passwordHash = await bcrypt.hash(validatedData.password, 12);
    const newUser = await userRepository.create({
      name: validatedData.name,
      email: validatedData.email,
      passwordHash
    });

    return NextResponse.json({ 
      message: 'Registration successful', 
      user: { id: newUser._id, name: newUser.name, email: newUser.email }
    }, { status: 201 });

  } catch (error) {
    if (error instanceof z.ZodError) {
      return NextResponse.json({ error: 'Invalid input', details: error.errors }, { status: 400 });
    }
    console.error('Registration error:', error);
    return NextResponse.json({ error: 'Registration failed' }, { status: 500 });
  }
}
```

### Component Architecture Implementation
[Source: architecture/components.md]
**Auth UI Component Requirements:**
- **Responsibility**: Provides user interface for registration and login
- **Key Interfaces**: Renders on `/register` route; captures user credentials
- **Dependencies**: Auth Service on the backend
- **Technology Stack**: Next.js, React, Shadcn/ui, Tailwind CSS

**Required Form Features:**
- Form fields: name, email, password, confirm password
- Client-side validation with real-time feedback
- Loading states during submission
- Success/error message display
- Responsive design with proper accessibility

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Framework**: Next.js ~14.2 with App Router
- **UI Components**: Shadcn/ui components (Button, Input, Label, Alert)
- **Styling**: Tailwind CSS ~3.4 for responsive design
- **Authentication**: NextAuth.js ~4.24 for session management (future integration)
- **Validation**: Zod for both client and server-side validation
- **Password Hashing**: bcryptjs for secure password storage
- **Testing**: Jest & React Testing Library for component/API testing

### Database Integration
From Story 1.2 context:
- Use existing UserRepository.findByEmail() to check for duplicates
- Use existing UserRepository.create() method for user creation
- Follow established Repository pattern - no direct Mongoose calls in API routes
- User schema already configured with proper email indexing and validation

### Coding Standards Compliance
[Source: architecture/coding-standards.md]
**Critical Requirements:**
- **Type Sharing**: Use User interface from packages/lib/src/types
- **Database Access**: All operations through UserRepository pattern
- **Environment Variables**: Access through centralized configuration
- **API Error Handling**: Use standardized error handler patterns
- **Naming Conventions**: Components in PascalCase, API routes in kebab-case

### Testing Standards
[Source: architecture/testing-strategy.md]
**Frontend Component Tests:**
```typescript
// src/components/features/RegistrationForm.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { RegistrationForm } from './RegistrationForm';

describe('RegistrationForm', () => {
  it('should show validation errors for invalid input', async () => {
    render(<RegistrationForm />);
    const submitButton = screen.getByRole('button', { name: /register/i });
    
    fireEvent.click(submitButton);
    
    await waitFor(() => {
      expect(screen.getByText(/name is required/i)).toBeInTheDocument();
      expect(screen.getByText(/please enter a valid email/i)).toBeInTheDocument();
    });
  });
});
```

**Backend API Tests:**
```typescript
// src/app/api/auth/register/route.test.ts
import { POST } from './route';

describe('POST /api/auth/register', () => {
  it('should create a user with valid data', async () => {
    const request = new Request('http://localhost/api/auth/register', {
      method: 'POST',
      body: JSON.stringify({
        name: 'Test User',
        email: 'test@example.com',
        password: 'password123'
      })
    });

    const response = await POST(request);
    const data = await response.json();

    expect(response.status).toBe(201);
    expect(data.message).toBe('Registration successful');
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-02-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet - Full Stack Developer implementation

### Debug Log References
- TypeScript errors in test files resolved through proper jest-dom setup
- Path mapping issues fixed in jest.config.js (moduleNameMapping → moduleNameMapper)
- bcrypt mock configuration adjusted for proper test execution
- Component accessibility attributes verified through testing

### Completion Notes List
1. **Registration Page Route**: Complete `/register` route with responsive design and Next.js App Router structure
2. **Registration Form Component**: Full form implementation with client-side validation, loading states, accessibility features
3. **API Endpoint**: Secure registration endpoint with Zod validation, bcrypt hashing (12 salt rounds), duplicate email prevention
4. **Frontend-Backend Integration**: Complete integration with proper error handling and success flows
5. **Testing Coverage**: Comprehensive test suites for both component behavior and API endpoint functionality
6. **UI Components**: Custom Shadcn/ui components (Button, Input, Label) integrated with proper TypeScript interfaces
7. **Security Implementation**: Password strength validation, secure hashing, SQL injection prevention through UserRepository pattern

### File List
**Created/Modified Files:**
- `apps/web/src/app/(auth)/register/page.tsx` - Registration page route
- `apps/web/src/components/features/RegistrationForm.tsx` - Main registration form component
- `apps/web/src/components/ui/button.tsx` - Reusable Button component
- `apps/web/src/components/ui/input.tsx` - Reusable Input component  
- `apps/web/src/components/ui/label.tsx` - Reusable Label component
- `apps/web/src/app/api/auth/register/route.ts` - Registration API endpoint
- `apps/web/src/components/features/RegistrationForm.test.tsx` - Component test suite
- `apps/web/src/app/api/auth/register/route.test.ts` - API endpoint test suite
- `apps/web/jest.config.js` - Updated Jest configuration with proper path mapping
- `apps/web/package.json` - Updated dependencies (react-hook-form, zod, bcryptjs, radix-ui components)

## QA Results
[To be populated by QA agent]
