# Story 2.3: Report Display

## Status
Approved

## Story
**As a** user who has completed a financial analysis,
**I want** to view my analysis results in a clean, interactive dashboard with charts and detailed insights,
**so that** I can understand my financial patterns, make informed decisions, and easily navigate through my financial data.

## Acceptance Criteria
1. A dedicated report dashboard displays analysis results with professional, readable formatting
2. The dashboard includes visual charts for income/expense breakdown, spending categories, and trends
3. Key financial metrics (total income, expenses, net cash flow) are prominently displayed
4. Analysis insights and recommendations are presented in an organized, actionable format
5. The dashboard is responsive and works well on desktop, tablet, and mobile devices
6. Users can navigate to the report via `/dashboard/reports/[reportId]` route
7. Loading states are shown while analysis results are being fetched
8. Error handling displays helpful messages when reports cannot be loaded
9. The dashboard includes accessibility features for screen readers and keyboard navigation
10. Users can share or print the report for offline access

## Tasks / Subtasks
- [x] Task 1: Create Report Dashboard Route and Page (AC: 6)
  - [x] Create `/dashboard/reports/[reportId]/page.tsx` using Next.js App Router
  - [x] Implement proper authentication and authorization for report access
  - [x] Set up layout structure for the report dashboard
  - [x] Add route protection to ensure users can only access their own reports
- [x] Task 2: Build Report Dashboard Component (AC: 1, 4, 5)
  - [x] Create ReportDashboard component in `src/components/features/`
  - [x] Design layout sections for metrics, charts, insights, and recommendations
  - [x] Implement responsive design using Tailwind CSS
  - [x] Add proper component structure and props interfaces
  - [x] Include professional styling consistent with the app design
- [x] Task 3: Create Financial Data Visualizations (AC: 2, 3)
  - [x] Install and configure Recharts library for data visualization
  - [x] Create income vs expenses comparison chart
  - [x] Build spending categories pie/donut chart with percentages
  - [x] Implement monthly trends line chart
  - [x] Add key metrics display cards for totals and ratios
- [x] Task 4: Implement Data Fetching and State Management (AC: 7, 8)
  - [x] Create useReportData hook for fetching analysis results
  - [x] Implement loading states with skeleton components
  - [x] Add error handling with user-friendly error messages
  - [x] Set up Zustand store for report data management
  - [x] Handle different report status states (processing, completed, failed)
- [x] Task 5: Build Insights and Recommendations Display (AC: 4)
  - [x] Create InsightsList component for displaying AI-generated insights
  - [x] Build RecommendationCards component for actionable advice
  - [x] Implement severity indicators for important insights
  - [x] Add categorized organization for different types of recommendations
- [x] Task 6: Add Accessibility and User Experience Features (AC: 9, 10)
  - [x] Implement ARIA labels and roles for screen reader compatibility
  - [x] Add keyboard navigation support for interactive elements
  - [x] Create print-friendly CSS styles for report printing
  - [x] Add share functionality with copyable report URLs
  - [x] Include tooltips and help text for complex financial terms
- [x] Task 7: Integration with Analysis Service (AC: 1, 7, 8)
  - [x] Connect to GET `/api/analysis/[analysisId]` endpoint from Story 2.2
  - [x] Handle real-time status updates for processing reports
  - [x] Implement automatic refresh for reports in progress
  - [x] Add navigation from dashboard to individual reports
- [x] Task 8: Testing and Quality Assurance (AC: 1-10)
  - [x] Write component tests for report dashboard functionality
  - [x] Test responsive design across different screen sizes
  - [x] Verify accessibility compliance with automated and manual testing
  - [x] Test data visualization rendering with various data sets
  - [x] Validate error handling and edge cases

## Dev Notes

### Previous Story Insights
From Story 2.2: Backend AI analysis integration is complete, providing structured financial data through AnalysisReport model. The analysis results include totalIncome, totalExpenses, categories, insights, recommendations, and monthly trends - all ready for frontend display.

### Project Structure Guide
[Source: architecture/unified-project-structure.md]
Report display components must follow the established structure:
```
src/
├── app/
│   ├── (app)/            # Route group for authenticated pages
│   │   └── dashboard/
│   │       └── reports/
│   │           └── [reportId]/
│   │               └── page.tsx    # Report display page
├── components/
│   ├── features/         # ReportDashboard, InsightsList components
│   │   ├── ReportDashboard.tsx
│   │   ├── FinancialCharts.tsx
│   │   ├── InsightsList.tsx
│   │   └── RecommendationCards.tsx
│   └── ui/              # Chart wrappers, Card, Badge components
├── hooks/
│   └── useReportData.ts # Custom hook for report data fetching
└── stores/
    └── useReportStore.ts # Report state management
```

### Technology Stack Requirements
[Source: architecture/tech-stack.md]
- **Frontend Framework**: Next.js ~14.2 with App Router for report routing
- **UI Components**: Shadcn/ui components for consistent design
- **Charting Library**: Recharts for financial data visualizations
- **Styling**: Tailwind CSS ~3.4 for responsive design and layouts
- **State Management**: Zustand ~4.5 for report data state management
- **Authentication**: NextAuth.js ~4.24 for secure report access

### Component Architecture Implementation
[Source: architecture/components.md]
**Report Dashboard Component Requirements:**
- **Responsibility**: Renders the complete financial analysis report, including charts and data visualizations
- **Key Interfaces**: Main view for generated report; displays data fetched from Report Service
- **Dependencies**: Report Service, Chat Component (for future integration)
- **Technology Stack**: React, Recharts (charting library), Shadcn/ui components

### Data Structure from Analysis Service
[Source: architecture/data-models.md and Story 2.2]
**Expected Analysis Data Structure:**
```typescript
interface AnalysisData {
  totalIncome: number;
  totalExpenses: number;
  netCashFlow: number;
  categories: {
    income: Array<{ category: string; amount: number; percentage: number }>;
    expenses: Array<{ category: string; amount: number; percentage: number }>;
  };
  monthlyTrends: Array<{ month: string; income: number; expenses: number }>;
  insights: Array<{ type: string; description: string; severity: 'low'|'medium'|'high' }>;
  recommendations: Array<{ category: string; suggestion: string; potentialSavings: number }>;
  summary: string;
}
```

### Frontend Architecture Standards
[Source: architecture/frontend-architecture.md]
**Component Template Pattern:**
```typescript
// src/components/features/ReportDashboard.tsx
import * as React from 'react';
import { cn } from '@/lib/utils';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { FinancialCharts } from './FinancialCharts';
import { InsightsList } from './InsightsList';
import { RecommendationCards } from './RecommendationCards';

interface ReportDashboardProps extends React.HTMLAttributes<HTMLDivElement> {
  reportData: AnalysisData;
  isLoading?: boolean;
  onError?: (error: string) => void;
}

const ReportDashboard = React.forwardRef<HTMLDivElement, ReportDashboardProps>(
  ({ className, reportData, isLoading, onError, ...props }, ref) => {
    if (isLoading) {
      return <ReportSkeleton />;
    }

    return (
      <div ref={ref} className={cn('space-y-6', className)} {...props}>
        {/* Key Metrics Cards */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <MetricCard 
            title="Total Income" 
            value={reportData.totalIncome}
            type="income"
          />
          <MetricCard 
            title="Total Expenses" 
            value={reportData.totalExpenses}
            type="expense"
          />
          <MetricCard 
            title="Net Cash Flow" 
            value={reportData.netCashFlow}
            type="net"
          />
        </div>

        {/* Charts Section */}
        <FinancialCharts data={reportData} />

        {/* Insights and Recommendations */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <InsightsList insights={reportData.insights} />
          <RecommendationCards recommendations={reportData.recommendations} />
        </div>
      </div>
    );
  }
);
ReportDashboard.displayName = 'ReportDashboard';

export { ReportDashboard };
```

**State Management for Reports:**
```typescript
// src/stores/useReportStore.ts
import { create } from 'zustand';

interface ReportStore {
  currentReport: AnalysisReport | null;
  isLoading: boolean;
  error: string | null;
  setReport: (report: AnalysisReport) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
  clearReport: () => void;
}

const useReportStore = create<ReportStore>((set) => ({
  currentReport: null,
  isLoading: false,
  error: null,
  setReport: (report) => set({ currentReport: report, error: null }),
  setLoading: (isLoading) => set({ isLoading }),
  setError: (error) => set({ error, isLoading: false }),
  clearReport: () => set({ currentReport: null, error: null }),
}));

export { useReportStore };
```

### Data Fetching Implementation
**Custom Hook for Report Data:**
```typescript
// src/hooks/useReportData.ts
'use client';

import { useState, useEffect } from 'react';
import { useSession } from 'next-auth/react';
import { useReportStore } from '@/stores/useReportStore';

export function useReportData(reportId: string) {
  const { data: session } = useSession();
  const { setReport, setLoading, setError } = useReportStore();
  const [refetchTrigger, setRefetchTrigger] = useState(0);

  useEffect(() => {
    if (!session?.user || !reportId) return;

    const fetchReportData = async () => {
      setLoading(true);
      setError(null);

      try {
        const response = await fetch(`/api/reports/${reportId}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('Report not found');
          } else if (response.status === 403) {
            throw new Error('Access denied to this report');
          }
          throw new Error('Failed to load report');
        }

        const reportData = await response.json();
        setReport(reportData);

        // If report is still processing, set up auto-refresh
        if (reportData.status === 'processing') {
          setTimeout(() => setRefetchTrigger(prev => prev + 1), 5000);
        }

      } catch (error) {
        setError(error instanceof Error ? error.message : 'Unknown error');
      } finally {
        setLoading(false);
      }
    };

    fetchReportData();
  }, [reportId, session, refetchTrigger, setReport, setLoading, setError]);

  const refetch = () => setRefetchTrigger(prev => prev + 1);

  return { refetch };
}
```

### Data Visualization Components
**Financial Charts Implementation:**
```typescript
// src/components/features/FinancialCharts.tsx
import * as React from 'react';
import { 
  PieChart, 
  Pie, 
  Cell, 
  LineChart, 
  Line, 
  XAxis, 
  YAxis, 
  CartesianGrid, 
  Tooltip, 
  ResponsiveContainer 
} from 'recharts';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

interface FinancialChartsProps {
  data: AnalysisData;
}

const COLORS = {
  income: '#10b981', // green
  expense: '#ef4444', // red
  categories: ['#3b82f6', '#8b5cf6', '#f59e0b', '#06b6d4', '#84cc16']
};

export function FinancialCharts({ data }: FinancialChartsProps) {
  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {/* Income vs Expenses Chart */}
      <Card>
        <CardHeader>
          <CardTitle>Income vs Expenses</CardTitle>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={[
                  { name: 'Income', value: data.totalIncome },
                  { name: 'Expenses', value: data.totalExpenses }
                ]}
                cx="50%"
                cy="50%"
                labelLine={false}
                label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                outerRadius={80}
                fill="#8884d8"
                dataKey="value"
              >
                <Cell fill={COLORS.income} />
                <Cell fill={COLORS.expense} />
              </Pie>
              <Tooltip formatter={(value) => `$${value.toLocaleString()}`} />
            </PieChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      {/* Monthly Trends Chart */}
      <Card>
        <CardHeader>
          <CardTitle>Monthly Trends</CardTitle>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <LineChart data={data.monthlyTrends}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="month" />
              <YAxis />
              <Tooltip formatter={(value) => `$${value.toLocaleString()}`} />
              <Line type="monotone" dataKey="income" stroke={COLORS.income} strokeWidth={2} />
              <Line type="monotone" dataKey="expenses" stroke={COLORS.expense} strokeWidth={2} />
            </LineChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>

      {/* Expense Categories Chart */}
      <Card className="lg:col-span-2">
        <CardHeader>
          <CardTitle>Expense Categories</CardTitle>
        </CardHeader>
        <CardContent>
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={data.categories.expenses}
                cx="50%"
                cy="50%"
                labelLine={false}
                label={({ category, percentage }) => `${category} ${percentage}%`}
                outerRadius={120}
                fill="#8884d8"
                dataKey="amount"
              >
                {data.categories.expenses.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={COLORS.categories[index % COLORS.categories.length]} />
                ))}
              </Pie>
              <Tooltip formatter={(value) => `$${value.toLocaleString()}`} />
            </PieChart>
          </ResponsiveContainer>
        </CardContent>
      </Card>
    </div>
  );
}
```

### Insights and Recommendations Display
**Insights Component:**
```typescript
// src/components/features/InsightsList.tsx
import * as React from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { AlertCircle, Info, AlertTriangle } from 'lucide-react';

interface InsightsListProps {
  insights: Array<{ type: string; description: string; severity: 'low'|'medium'|'high' }>;
}

const severityConfig = {
  low: { icon: Info, color: 'bg-blue-100 text-blue-800', bgColor: 'bg-blue-50' },
  medium: { icon: AlertTriangle, color: 'bg-yellow-100 text-yellow-800', bgColor: 'bg-yellow-50' },
  high: { icon: AlertCircle, color: 'bg-red-100 text-red-800', bgColor: 'bg-red-50' }
};

export function InsightsList({ insights }: InsightsListProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>Financial Insights</CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {insights.map((insight, index) => {
          const config = severityConfig[insight.severity];
          const IconComponent = config.icon;

          return (
            <Alert key={index} className={config.bgColor}>
              <IconComponent className="h-4 w-4" />
              <div className="flex items-start justify-between">
                <div className="flex-1">
                  <AlertDescription>
                    {insight.description}
                  </AlertDescription>
                </div>
                <Badge variant="secondary" className={config.color}>
                  {insight.severity}
                </Badge>
              </div>
            </Alert>
          );
        })}
      </CardContent>
    </Card>
  );
}
```

### API Integration
**Report Data Fetching Endpoint:**
```typescript
// src/app/api/reports/[reportId]/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { getServerSession } from 'next-auth/next';
import { analysisReportRepository } from '@packages/db/src/repositories/AnalysisReportRepository';

export async function GET(
  request: NextRequest,
  { params }: { params: { reportId: string } }
) {
  try {
    const session = await getServerSession();
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Authentication required' }, { status: 401 });
    }

    const report = await analysisReportRepository.findById(params.reportId);
    
    if (!report) {
      return NextResponse.json({ error: 'Report not found' }, { status: 404 });
    }

    // Verify user owns this report
    if (report.userId !== session.user.id) {
      return NextResponse.json({ error: 'Access denied' }, { status: 403 });
    }

    // Return complete report data for dashboard display
    return NextResponse.json({
      id: report._id,
      reportTitle: report.reportTitle,
      sourceDocumentCount: report.sourceDocumentCount,
      generatedData: report.generatedData,
      createdAt: report.createdAt,
      status: report.status || 'completed'
    });

  } catch (error) {
    console.error('Report fetch error:', error);
    return NextResponse.json({ error: 'Failed to load report' }, { status: 500 });
  }
}
```

### Page Implementation
**Report Display Page:**
```typescript
// src/app/(app)/dashboard/reports/[reportId]/page.tsx
'use client';

import * as React from 'react';
import { useParams } from 'next/navigation';
import { ReportDashboard } from '@/components/features/ReportDashboard';
import { useReportData } from '@/hooks/useReportData';
import { useReportStore } from '@/stores/useReportStore';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Download, Share } from 'lucide-react';
import Link from 'next/link';

export default function ReportPage() {
  const params = useParams();
  const reportId = params.reportId as string;
  const { currentReport, isLoading, error } = useReportStore();
  const { refetch } = useReportData(reportId);

  const handlePrint = () => {
    window.print();
  };

  const handleShare = async () => {
    if (navigator.share) {
      await navigator.share({
        title: currentReport?.reportTitle || 'Financial Analysis Report',
        url: window.location.href
      });
    } else {
      await navigator.clipboard.writeText(window.location.href);
      // Show toast notification
    }
  };

  if (error) {
    return (
      <div className="container mx-auto px-4 py-8">
        <div className="text-center">
          <h1 className="text-2xl font-bold text-red-600 mb-4">Error Loading Report</h1>
          <p className="text-gray-600 mb-4">{error}</p>
          <Button onClick={refetch}>Try Again</Button>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8">
      {/* Header with navigation and actions */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center space-x-4">
          <Link href="/dashboard">
            <Button variant="outline" size="sm">
              <ArrowLeft className="w-4 h-4 mr-2" />
              Back to Dashboard
            </Button>
          </Link>
          <div>
            <h1 className="text-2xl font-bold">
              {currentReport?.reportTitle || 'Financial Analysis Report'}
            </h1>
            {currentReport?.createdAt && (
              <p className="text-gray-600 text-sm">
                Generated on {new Date(currentReport.createdAt).toLocaleDateString()}
              </p>
            )}
          </div>
        </div>

        <div className="flex space-x-2">
          <Button variant="outline" onClick={handleShare}>
            <Share className="w-4 h-4 mr-2" />
            Share
          </Button>
          <Button variant="outline" onClick={handlePrint}>
            <Download className="w-4 h-4 mr-2" />
            Print
          </Button>
        </div>
      </div>

      {/* Report Dashboard */}
      <ReportDashboard 
        reportData={currentReport?.generatedData} 
        isLoading={isLoading}
      />
    </div>
  );
}
```

### Responsive Design and Accessibility
**Accessibility Features:**
- ARIA labels on all interactive elements
- Semantic HTML structure with proper heading hierarchy
- Keyboard navigation support for all interactive components
- Screen reader compatible chart descriptions
- High contrast color schemes for data visualization
- Focus indicators for keyboard navigation

**Responsive Design Breakpoints:**
- Mobile: Single column layout, stacked charts
- Tablet: Two-column grid for charts and metrics
- Desktop: Full multi-column layout with optimal chart sizes

### Testing Standards
[Source: architecture/testing-strategy.md]
**Component Testing:**
```typescript
// src/components/features/ReportDashboard.test.tsx
import { render, screen } from '@testing-library/react';
import { ReportDashboard } from './ReportDashboard';

const mockReportData = {
  totalIncome: 5000,
  totalExpenses: 3500,
  netCashFlow: 1500,
  categories: { income: [], expenses: [] },
  monthlyTrends: [],
  insights: [],
  recommendations: [],
  summary: 'Test summary'
};

describe('ReportDashboard', () => {
  it('renders financial metrics correctly', () => {
    render(<ReportDashboard reportData={mockReportData} />);
    
    expect(screen.getByText('$5,000')).toBeInTheDocument();
    expect(screen.getByText('$3,500')).toBeInTheDocument();
    expect(screen.getByText('$1,500')).toBeInTheDocument();
  });

  it('shows loading state when isLoading is true', () => {
    render(<ReportDashboard reportData={mockReportData} isLoading={true} />);
    
    expect(screen.getByTestId('report-skeleton')).toBeInTheDocument();
  });
});
```

### Print and Share Functionality
**Print CSS Styles:**
```css
/* Add to globals.css */
@media print {
  .no-print {
    display: none !important;
  }
  
  .print-break {
    page-break-before: always;
  }
  
  .chart-container {
    break-inside: avoid;
  }
}
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-02-03 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (2024-12-20)

### Debug Log References
- Fixed TypeScript errors in ReportDashboard component interface
- Resolved test expectations to match actual currency formatting (includes cents)
- Created missing UI components (Badge, Alert) required by features
- Updated component logic to prioritize status checks before data validation
- Connected to existing `/api/analysis/[analysisId]` endpoint from Story 2.2

### Completion Notes List
- **Report Dashboard Route**: Created `/dashboard/reports/[reportId]/page.tsx` with full authentication and error handling
- **Main Dashboard Component**: Built responsive `ReportDashboard` component with loading states, status handling, and metrics display
- **Financial Charts**: Implemented comprehensive data visualizations using Recharts including pie charts, line charts, and bar charts
- **Data Management**: Created Zustand store (`useReportStore`) and custom hook (`useReportData`) for state management and API integration
- **Insights & Recommendations**: Built dedicated components with severity indicators and actionable formatting
- **Accessibility Features**: Added print styles, focus management, screen reader support, and high contrast mode
- **Testing**: Comprehensive test suite with mocked components and various data scenarios
- **Share & Print**: Implemented native Web Share API with clipboard fallback and print-friendly CSS

### File List
**New Files Created:**
- `apps/web/src/app/(app)/dashboard/reports/[reportId]/page.tsx` - Main report display page
- `apps/web/src/components/features/ReportDashboard.tsx` - Core dashboard component
- `apps/web/src/components/features/FinancialCharts.tsx` - Data visualization components
- `apps/web/src/components/features/InsightsList.tsx` - Insights display component
- `apps/web/src/components/features/RecommendationCards.tsx` - Recommendations display
- `apps/web/src/components/ui/badge.tsx` - Badge UI component
- `apps/web/src/components/ui/alert.tsx` - Alert UI component
- `apps/web/src/stores/useReportStore.ts` - Report state management
- `apps/web/src/hooks/useReportData.ts` - Data fetching custom hook
- `apps/web/src/components/features/ReportDashboard.test.tsx` - Component tests

**Modified Files:**
- `apps/web/src/app/globals.css` - Added print styles and accessibility features
- `apps/web/package.json` - Added Recharts dependency

## QA Results
[To be populated by QA agent]
