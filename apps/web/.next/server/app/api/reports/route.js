"use strict";(()=>{var e={};e.id=867,e.ids=[867,944,919],e.modules={11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},35034:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},69546:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>x,requestAsyncStorage:()=>y,routeModule:()=>m,serverHooks:()=>g,staticGenerationAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{GET:()=>p,dynamic:()=>l});var a=r(63036),s=r(5736),i=r(15262),o=r(60942),u=r(1295),d=r(89254),c=r(50944);let l="force-dynamic";async function p(e){try{let t=await (0,u.getServerSession)();if(!t?.user?.email)return o.NextResponse.json({error:"Authentication required"},{status:401});let r=await c.userRepository.findByEmail(t.user.email);if(!r)return o.NextResponse.json({error:"User account not found"},{status:404});let{searchParams:n}=new URL(e.url),a=parseInt(n.get("page")||"1"),s=parseInt(n.get("limit")||"10"),i=n.get("search")||"",l=n.get("startDate"),p=n.get("endDate"),m=n.get("status"),y={userId:r._id};i&&(y.reportTitle={$regex:i,$options:"i"}),l&&p?y.createdAt={$gte:new Date(l),$lte:new Date(p+"T23:59:59.999Z")}:l?y.createdAt={$gte:new Date(l)}:p&&(y.createdAt={$lte:new Date(p+"T23:59:59.999Z")}),m&&""!==m&&(y.status=m);let w=await d.M.findPaginated(y,{page:a,limit:s,sort:{createdAt:-1}}),g=w.data.map(e=>({id:e._id,title:e.reportTitle,createdAt:e.createdAt,sourceDocumentCount:e.sourceDocumentCount,status:e.status||"completed",keyMetrics:{totalIncome:e.generatedData?.totalIncome||0,totalExpenses:e.generatedData?.totalExpenses||0,netCashFlow:e.generatedData?.netCashFlow||0}}));return o.NextResponse.json({reports:g,pagination:{page:w.page,limit:w.limit,total:w.total,pages:w.pages}})}catch(e){return console.error("Report history error:",e),o.NextResponse.json({error:"Failed to fetch report history"},{status:500})}}let m=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/reports/route",pathname:"/api/reports",filename:"route",bundlePath:"app/api/reports/route"},resolvedPagePath:"/Users/shrijayan.rajendran/projects/personal/bank_statement/apps/web/src/app/api/reports/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:w,serverHooks:g}=m,h="/api/reports/route";function x(){return(0,i.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:w})}},77919:(e,t,r)=>{r.d(t,{Z:()=>i});var n=r(11185),a=r.n(n);let s=global.mongoose;s||(s=global.mongoose={conn:null,promise:null});let i=async function(){if(s.conn)return s.conn;if(!s.promise){let e=process.env.MONGODB_URI;if(!e)throw Error("Please define the MONGODB_URI environment variable inside .env.local");s.promise=a().connect(e,{bufferCommands:!1}).then(e=>e)}try{s.conn=await s.promise}catch(e){throw s.promise=null,e}return s.conn}},89254:(e,t,r)=>{r.d(t,{M:()=>d});var n=r(11185),a=r.n(n);let s=new(a()).Schema({userId:{type:a().Schema.Types.ObjectId,ref:"User",required:!0,index:!0},uploadId:{type:String,required:!1},reportTitle:{type:String,required:!0},sourceDocumentCount:{type:Number,required:!0},status:{type:String,enum:["processing","completed","failed"],default:"processing",required:!0},progress:{type:Number,min:0,max:100,default:0},generatedData:{type:Object,required:!1},completedAt:{type:Date,required:!1}},{timestamps:!0});s.index({userId:1,createdAt:-1}),s.index({status:1}),s.index({userId:1,status:1});let i=a().models?.AnalysisReport||a().model("AnalysisReport",s);var o=r(77919);class u{async ensureConnection(){process.env.JEST_WORKER_ID||await (0,o.Z)()}async create(e){await this.ensureConnection();let t=new i({userId:e.userId,uploadId:e.uploadId,reportTitle:e.reportTitle,sourceDocumentCount:e.sourceDocumentCount,status:e.status||"processing",progress:e.progress||0,generatedData:e.generatedData}),r=await t.save();return this.transformToPublicReport(r)}async findById(e){await this.ensureConnection();let t=await i.findById(e).exec();return t?this.transformToPublicReport(t):null}async findByUserId(e,t=50){return await this.ensureConnection(),(await i.find({userId:e}).sort({createdAt:-1}).limit(t).exec()).map(e=>this.transformToPublicReport(e))}async findByUserIdAndStatus(e,t,r=50){return await this.ensureConnection(),(await i.find({userId:e,status:t}).sort({createdAt:-1}).limit(r).exec()).map(e=>this.transformToPublicReport(e))}async updateById(e,t){await this.ensureConnection();let r={};void 0!==t.reportTitle&&(r.reportTitle=t.reportTitle),void 0!==t.status&&(r.status=t.status),void 0!==t.progress&&(r.progress=t.progress),void 0!==t.generatedData&&(r.generatedData=t.generatedData),void 0!==t.completedAt&&(r.completedAt=t.completedAt);let n=await i.findByIdAndUpdate(e,{$set:r},{new:!0,runValidators:!0}).exec();return n?this.transformToPublicReport(n):null}async deleteById(e){return await this.ensureConnection(),!!await i.findByIdAndDelete(e).exec()}async deleteByUserId(e){return await this.ensureConnection(),(await i.deleteMany({userId:e}).exec()).deletedCount||0}async findByUploadId(e){await this.ensureConnection();let t=await i.findOne({uploadId:e}).exec();return t?this.transformToPublicReport(t):null}async countByUserId(e){return await this.ensureConnection(),i.countDocuments({userId:e}).exec()}async countByUserIdAndStatus(e,t){return await this.ensureConnection(),i.countDocuments({userId:e,status:t}).exec()}async findPaginated(e,t){await this.ensureConnection();let{page:r,limit:n,sort:a={createdAt:-1}}=t,[s,o]=await Promise.all([i.find(e).sort(a).skip((r-1)*n).limit(n).exec(),i.countDocuments(e).exec()]);return{data:s.map(e=>this.transformToPublicReport(e)),page:r,limit:n,total:o,pages:Math.ceil(o/n)}}async deleteByIdAndUserId(e,t){return await this.ensureConnection(),!!await i.findOneAndDelete({_id:e,userId:t}).exec()}transformToPublicReport(e){return{_id:e._id.toString(),userId:e.userId,uploadId:e.uploadId,reportTitle:e.reportTitle,sourceDocumentCount:e.sourceDocumentCount,status:e.status,progress:e.progress,generatedData:e.generatedData,createdAt:e.createdAt,updatedAt:e.updatedAt,completedAt:e.completedAt}}}let d=new u},50944:(e,t,r)=>{r.d(t,{userRepository:()=>d});var n=r(11185),a=r.n(n);let s=new n.Schema({name:{type:String,required:[!0,"Name is required"],trim:!0,maxlength:[100,"Name cannot exceed 100 characters"]},email:{type:String,required:[!0,"Email is required"],unique:!0,lowercase:!0,trim:!0,match:[/^\w+([.-]?\w+)*@\w+([.-]?\w+)*(\.\w{2,3})+$/,"Please enter a valid email address"]},password:{type:String,required:[!0,"Password is required"],minlength:[6,"Password must be at least 6 characters long"]}},{timestamps:!0,collection:"users"}),i=a().models.User||a().model("User",s);var o=r(77919);class u{async ensureConnection(){process.env.JEST_WORKER_ID||await (0,o.Z)()}async findByEmail(e){await this.ensureConnection();let t=await i.findOne({email:e}).exec();return t?this.transformToPublicUser(t):null}async findById(e){await this.ensureConnection();let t=await i.findById(e).exec();return t?this.transformToPublicUser(t):null}async create(e){await this.ensureConnection();let t=new i({name:e.name,email:e.email,password:e.password}),r=await t.save();return this.transformToPublicUser(r)}async updateById(e,t){await this.ensureConnection();let r=await i.findByIdAndUpdate(e,{$set:t},{new:!0,runValidators:!0}).exec();return r?this.transformToPublicUser(r):null}async deleteById(e){return await this.ensureConnection(),!!await i.findByIdAndDelete(e).exec()}async existsByEmail(e){return await this.ensureConnection(),await i.countDocuments({email:e}).exec()>0}async findByEmailWithPassword(e){return await this.ensureConnection(),i.findOne({email:e}).exec()}transformToPublicUser(e){return{_id:e._id.toString(),name:e.name,email:e.email,createdAt:e.createdAt,updatedAt:e.updatedAt}}}let d=new u}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[522,295,746],()=>r(69546));module.exports=n})();